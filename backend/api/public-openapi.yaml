# Copyright (c) 2025, WSO2 LLC. (http://www.wso2.com). All Rights Reserved.
#
# This software is the property of WSO2 LLC. and its suppliers, if any.
# Dissemination of any information or reproduction of any material contained
# herein in any form is strictly forbidden, unless permitted by WSO2 expressly.
# You may not alter or remove any copyright or other notice from copies of this content.

openapi: 3.0.3
info:
  title: Policy Hub Public API v1
  description: |
    The Policy Hub Public API v1 is a comprehensive platform for managing and distributing API platform policies.
    It provides endpoints for discovering, versioning, and retrieving policy definitions, metadata, and documentation.
    Key features include policy search and filtering, version management, batch retrieval, and documentation access.
  version: 1.0.0
  contact:
    name: WSO2
    url: https://wso2.com

servers:
  - url: http://localhost:8080/api/v1
    description: Local development server
  - url: https://api.policyhub.wso2.com/api/v1
    description: Production server

tags:
  - name: policies
    description: Policy management operations
  - name: versions
    description: Policy version operations
  - name: docs
    description: Documentation operations

paths:
  /policies:
    get:
      tags:
        - policies
      summary: List all policies
      operationId: listPolicies
      parameters:
        - name: search
          in: query
          description: Free text search across policy name, description, and tags
          required: false
          schema:
            type: string
            maxLength: 255
        - name: category
          in: query
          description: Filter by category (comma-separated for multiple categories)
          required: false
          schema:
            type: string
        - name: categories
          in: query
          description: Filter by categories (comma-separated, alternative to category parameter)
          required: false
          schema:
            type: string
        - name: provider
          in: query
          description: Filter by provider (comma-separated for multiple providers)
          required: false
          schema:
            type: string
        - name: providers
          in: query
          description: Filter by providers (comma-separated, alternative to provider parameter)
          required: false
          schema:
            type: string
        - name: platform
          in: query
          description: Filter by supported platform (comma-separated for multiple platforms)
          required: false
          schema:
            type: string
        - name: platforms
          in: query
          description: Filter by supported platforms (comma-separated, alternative to platform parameter)
          required: false
          schema:
            type: string
        - name: page
          in: query
          description: Page number
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: pageSize
          in: query
          description: Number of items per page
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: List of policies
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PoliciesListResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /policies/resolve:
    post:
      tags:
        - policies
      summary: Retrieve multiple policies with strategy-based version selection
      description: |
        Resolve endpoint to retrieve multiple policies with strategy-based version selection.
        Supports exact version matching, latest patch/minor/major version resolution.
        Maximum 100 policies per request. Version format must be d.d.d (e.g., "1.2.3").
      operationId: resolvePolicies
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/PolicyRequestItem'
              minItems: 1
              maxItems: 100
            example:
              - name: rate-limiting
                version: "1.1.0"
                versionResolution: exact
              - name: jwt-authentication
                version: "2.1"
                versionResolution: patch
              - name: cors-policy
                version: "1"
                versionResolution: minor
      responses:
        '200':
          description: Resolve policy retrieval response
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/PolicyResolveItem'
                  error:
                    nullable: true
                    example: null
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
                required:
                  - success
                  - data
                  - meta
        '400':
          description: Invalid request payload or batch size exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /policies/categories:
    get:
      tags:
        - policies
      summary: Get all available categories
      operationId: getCategories
      responses:
        '200':
          description: List of all categories
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoriesResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /policies/providers:
    get:
      tags:
        - policies
      summary: Get all available providers
      operationId: getProviders
      responses:
        '200':
          description: List of all providers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProvidersResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /policies/platforms:
    get:
      tags:
        - policies
      summary: Get all available platforms
      operationId: getPlatforms
      responses:
        '200':
          description: List of all platforms
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlatformsResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /policies/{name}:
    get:
      tags:
        - policies
      summary: Get policy summary with latest version
      operationId: getPolicySummary
      parameters:
        - name: name
          in: path
          required: true
          description: Policy name
          schema:
            type: string
      responses:
        '200':
          description: Policy summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PolicyResponse'
        '404':
          description: Policy not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /policies/{name}/versions:
    get:
      tags:
        - versions
      summary: List policy versions
      operationId: listPolicyVersions
      parameters:
        - name: name
          in: path
          required: true
          description: Policy name
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: pageSize
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: List of policy versions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PolicyVersionsResponse'
        '404':
          description: Policy not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /policies/{name}/versions/latest:
    get:
      tags:
        - versions
      summary: Get latest policy version
      description: Returns the most recent version of a policy for easy UI navigation
      operationId: getLatestVersion
      parameters:
        - name: name
          in: path
          required: true
          description: Policy name
          schema:
            type: string
      responses:
        '200':
          description: Latest policy version detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PolicyResponse'
        '404':
          description: Policy not found or has no versions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /policies/{name}/versions/{version}:
    get:
      tags:
        - versions
      summary: Get policy version metadata
      operationId: getPolicyVersionDetail
      parameters:
        - name: name
          in: path
          required: true
          description: Policy name
          schema:
            type: string
        - name: version
          in: path
          required: true
          description: Policy version
          schema:
            type: string
      responses:
        '200':
          description: Policy version detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PolicyResponse'
        '404':
          description: Policy version not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /policies/{name}/versions/{version}/definition:
    get:
      tags:
        - versions
      summary: Get raw policy definition (YAML format)
      operationId: getPolicyDefinition
      parameters:
        - name: name
          in: path
          required: true
          description: Policy name
          schema:
            type: string
        - name: version
          in: path
          required: true
          description: Policy version
          schema:
            type: string
      responses:
        '200':
          description: Raw policy definition
          content:
            text/yaml:
              schema:
                type: string
                description: Raw policy definition in YAML format
        '404':
          description: Policy version not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'



  /policies/{name}/versions/{version}/docs:
    get:
      tags:
        - docs
      summary: Get all documentation pages
      operationId: getAllDocs
      parameters:
        - name: name
          in: path
          required: true
          description: Policy name
          schema:
            type: string
        - name: version
          in: path
          required: true
          description: Policy version
          schema:
            type: string
      responses:
        '200':
          description: All documentation pages
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentationListResponse'
        '404':
          description: Policy version not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /policies/{name}/versions/{version}/docs/{page}:
    get:
      tags:
        - docs
      summary: Get a single documentation page
      operationId: getSingleDoc
      parameters:
        - name: name
          in: path
          required: true
          description: Policy name
          schema:
            type: string
        - name: version
          in: path
          required: true
          description: Policy version
          schema:
            type: string
        - name: page
          in: path
          required: true
          description: Documentation page name
          schema:
            type: string
            enum: [overview, configuration, examples, faq]
      responses:
        '200':
          description: Documentation page
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentationResponse'
        '404':
          description: Documentation page not found or policy version not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    ResponseMeta:
      type: object
      properties:
        trace_id:
          type: string
          example: "abc123"
        timestamp:
          type: string
          format: date-time
        request_id:
          type: string
          example: "xyz123"
      required:
        - trace_id
        - timestamp
        - request_id

    PaginatedResponseMeta:
      type: object
      properties:
        trace_id:
          type: string
          example: "abc123"
        timestamp:
          type: string
          format: date-time
        request_id:
          type: string
          example: "xyz123"
        pagination:
          $ref: '#/components/schemas/PaginationMeta'
      required:
        - trace_id
        - timestamp
        - request_id
        - pagination

    ErrorObject:
      type: object
      properties:
        code:
          type: string
          description: Machine-readable error code
          example: POLICY_VERSION_NOT_FOUND
        message:
          type: string
          description: Human-readable error message
          example: Policy not found
        details:
          type: object
          additionalProperties: true
          description: Optional structured context for debugging
      required:
        - code
        - message

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        data:
          nullable: true
          example: null
        error:
          $ref: '#/components/schemas/ErrorObject'
        meta:
          $ref: '#/components/schemas/ResponseMeta'
      required:
        - success
        - data
        - error
        - meta

    PoliciesListResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: array
          items:
            $ref: '#/components/schemas/Policy'
        error:
          nullable: true
          example: null
        meta:
          $ref: '#/components/schemas/PaginatedResponseMeta'
      required:
        - success
        - data
        - meta

    CategoriesResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: array
          items:
            type: string
          example: ["security", "networking", "compliance", "traffic-control"]
        error:
          nullable: true
          example: null
        meta:
          $ref: '#/components/schemas/ResponseMeta'
      required:
        - success
        - data
        - meta

    ProvidersResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: array
          items:
            type: string
          example: ["wso2", "community", "third-party"]
        error:
          nullable: true
          example: null
        meta:
          $ref: '#/components/schemas/ResponseMeta'
      required:
        - success
        - data
        - meta

    PlatformsResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: array
          items:
            type: string
          example: ["apim-4.5+", "kubernetes", "docker", "linux"]
        error:
          nullable: true
          example: null
        meta:
          $ref: '#/components/schemas/ResponseMeta'
      required:
        - success
        - data
        - meta

    PolicyResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/Policy'
        error:
          nullable: true
          example: null
        meta:
          $ref: '#/components/schemas/ResponseMeta'
      required:
        - success
        - data
        - meta

    PolicyVersionsResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: array
          items:
            $ref: '#/components/schemas/Policy'
        error:
          nullable: true
          example: null
        meta:
          $ref: '#/components/schemas/PaginatedResponseMeta'
      required:
        - success
        - data
        - meta

    DocumentationListResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: array
          description: Array of documentation pages (DocsAllResponseDTO)
          items:
            $ref: '#/components/schemas/PolicyDocumentation'
        error:
          nullable: true
          example: null
        meta:
          $ref: '#/components/schemas/ResponseMeta'
      required:
        - success
        - data
        - meta

    DocumentationResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/PolicyDocumentation'
        error:
          nullable: true
          example: null
        meta:
          $ref: '#/components/schemas/ResponseMeta'
      required:
        - success
        - data
        - meta

    PaginationMeta:
      type: object
      properties:
        page:
          type: integer
          minimum: 1
        pageSize:
          type: integer
          minimum: 1
        totalItems:
          type: integer
          minimum: 0
        totalPages:
          type: integer
          minimum: 0

    Policy:
      type: object
      description: Standardized policy object used across all GET endpoints
      properties:
        name:
          type: string
          example: rate-limit
        version:
          type: string
          example: v1.1.0
        displayName:
          type: string
          example: Rate Limiting Policy
        description:
          type: string
          example: Rate limit policy with enhanced schema
        provider:
          type: string
          example: WSO2
        categories:
          type: array
          items:
            type: string
          example: ["security", "traffic-control"]
        tags:
          type: array
          items:
            type: string
          example: ["limit", "quota"]
        supportedPlatforms:
          type: array
          items:
            type: string
          example: ["apim-4.5+"]
        logoUrl:
          type: string
          format: uri
          example: https://raw.githubusercontent.com/wso2/policies/rate-limiting/1.1.0/logo.svg
        bannerUrl:
          type: string
          format: uri
          example: https://raw.githubusercontent.com/wso2/policies/rate-limit/v1.1.0/banner.png
        iconUrl:
          type: string
          format: uri
          example: https://raw.githubusercontent.com/wso2/policies/rate-limit/v1.1.0/icon.svg
        releaseDate:
          type: string
          format: date
          example: "2025-02-15"
        isLatest:
          type: boolean
          example: true
        sourceType:
          type: string
          example: github
        downloadUrl:
          type: string
          format: uri
          example: https://github.com/wso2/policies/rate-limit

      required:
        - name
        - version
        - displayName
        - provider
        - categories  
        - tags
        - supportedPlatforms
        - isLatest

    PolicyRequestItem:
      type: object
      properties:
        name:
          type: string
          example: rate-limiting
          pattern: '^[a-zA-Z0-9_-]{3,64}$'
          minLength: 3
          maxLength: 64
        version:
          type: string
          example: "1.1.0"
          description: "Version string - can include 'v' prefix (e.g., 'v1.1.0' or '1.1.0'). Handler normalizes by removing 'v' prefix."
          maxLength: 50
        versionResolution:
          type: string
          enum: [exact, patch, minor]
          example: exact
          description: |
            Strategy for version retrieval (validated in handler):
            - exact: Get the exact version specified in version field
            - patch: Get latest patch version within major.minor from version
            - minor: Get latest minor version within major from version
            Note: 'major' resolution is NOT supported in current handler validation
          default: exact
      required:
        - name
        - version

    PolicyResolveItem:
      type: object
      properties:
        policy_name:
          type: string
          example: rate-limiting
        version:
          type: string
          example: "1.1.0"
        download_url:
          type: string
          example: "https://github.com/wso2/policy-hub/tree/main/storage/rate-limiting/1.1.0"
        checksum:
          type: object
          description: Checksum information (always present, may have empty values if source has no checksum)
          properties:
            algorithm:
              type: string
              example: SHA-256
              description: Checksum algorithm (empty string if no checksum available)
            value:
              type: string
              example: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855
              description: Checksum value (empty string if no checksum available)
          required:
            - algorithm
            - value
      required:
        - policy_name
        - version
        - download_url
        - checksum

    PolicyDocumentation:
      type: object
      properties:
        page:
          type: string
          enum: [overview, configuration, examples, faq]
        format:
          type: string
          enum: [markdown]
          example: markdown
        content:
          type: string
      required:
        - page
        - format
        - content
